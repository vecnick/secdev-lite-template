# Матрица сравнения вариантов для R-01 - Подмена OAuth токена

## 0) Контекст риска (из S04)

* **Risk-ID:** R-01
* **Threat:** S (Spoofing)
* **DFD element/edge:** Edge: Internet → Spring Boot Controller (OAuth токен)
* **NFR link (ID):** NFR-005
* **L×I (1-5):** L=4, I=5, Score=20
* **Ограничения/предпосылки:** Интеграция с HH.ru OAuth 2.0, публичный эндпоинт, требуется безопасный обмен токенами

## 1) Критерии и шкалы (1-5)

**Польза (↑):**
- **Security impact (↑):** защита от подмены и перехвата токенов
- **Blast radius reduction (↑):** ограничение ущерба при компрометации

**Стоимость/сложность (↓):**
- **Complexity (↓):** сложность реализации
- **Time-to-mitigate (↓):** время до внедрения
- **Dependencies (↓):** внешние зависимости

## 2) Таблица сравнения вариантов

| Alternative | Summary | Security impact (↑,1-5) | Blast radius reduction (↑,1-5) | Complexity (↓,1-5) | Time-to-mitigate (↓,1-5) | Dependencies (↓,1-5) | **Benefit** | **Cost** | **Net** | Notes |
| ----------- | ------- | ----------------------: | -----------------------------: | -----------------: | -----------------------: | -------------------: | ----------: | -------: | ------: | ----- |
| A | PKCE + короткий TTL токенов + state validation | 5 | 4 | 2 | 2 | 2 | **9** | **6** | **+3** | Соответствует OAuth 2.1, умеренная сложность |
| B | mTLS для всех клиентов | 5 | 5 | 5 | 5 | 5 | **10** | **15** | **-5** | Максимальная безопасность, но очень сложно |
| C | Только короткий TTL (15 мин) | 3 | 2 | 1 | 1 | 1 | **5** | **3** | **+2** | Просто, но недостаточно безопасно |

## 3) Тай-брейкеры при равенстве Net

* **Compliance/Privacy:** PKCE рекомендуется OAuth 2.1 и соответствует лучшим практикам
* **Maintainability:** PKCE проще в обслуживании чем mTLS
* **Team fit:** команда имеет опыт работы с OAuth/PKCE
* **Observability:** можно мониторить использование PKCE
* **Rollback safety:** можно откатить к простому TTL если возникнут проблемы

## 4) Решение (для переноса в ADR)

* **Chosen alternative:** A
* **Почему:** PKCE обеспечивает высокий уровень безопасности при умеренной сложности реализации. Соответствует современным стандартам OAuth 2.1 и защищает от атак подмены.
* **ADR candidate:** "OAuth 2.1 PKCE Implementation"
* **Связки:** Risk-ID R-01, NFR-ID NFR-005, DFD Edge Internet→Controller
* **Следующие шаги:**
  1. Настроить PKCE flow для HH.ru OAuth
  2. Установить TTL access token = 15 минут
  3. Реализовать валидацию state параметра
  4. Добавить мониторинг аутентификационных событий
