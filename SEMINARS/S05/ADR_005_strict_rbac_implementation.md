# ADR: Strict RBAC Implementation
Status: Approved

## Context
Risk: R-05 (L=3, I=4, Score=12) - Обход проверок прав доступа к данным других пользователей
DFD: Node Business Logic
NFR: need NFR (будет создан)
Assumptions: Сложная бизнес-логика, множественные точки доступа к данным, требование строгой изоляции

## Decision
Реализовать strict RBAC (Role-Based Access Control) с проверками владения на каждом слое приложения. Принцип "defense in depth" с обязательной проверкой прав доступа.

- **Роли:** USER, ADMIN с четко определенными permissions
- **Проверки владения:** обязательная валидация на Controller, Service и DAO уровнях
- **Ошибки доступа:** единообразные 404 (скрытие существования данных)
- **Аудит:** логирование всех попыток доступа к данным
- **Scope:** все операции с пользовательскими данными

## Alternatives
- **RBAC только на контроллере** - возможны обходы через прямой доступ к сервисам
- **Базовые проверки** - недостаточная защита для сложной бизнес-логики

## Consequences
+ Максимальная защита от несанкционированного доступа
+ Соответствие принципам минимальных привилегий и defense in depth
- Усложнение кодовой базы
- Требует строгой дисциплины при разработке новых функций

## DoD / Acceptance
Given пользователь A пытается получить доступ к данным пользователя B
When выполняется запрос через любой слой приложения
Then возвращается 404 без утечки информации о существовании данных

Checks:
- test: penetration testing на обход RBAC
- log: аудит всех попыток доступа с указанием роли и результата
- scan: отсутствие уязвимостей обхода прав доступа в SAST
- metric: 100% операций с данными проходят проверки владения

## Rollback / Fallback
Постепенное внедрение с feature flags. Резервные проверки на уровне базы данных.

## Trace
- DFD: Node Business Logic
- STRIDE: строка 5 (Elevation of Privilege threat)
- Risk scoring: R-05, Top-5
- NFR: NFR-009 (будет создан)
- Issues: RBAC implementation

## Ownership & Dates
Owner: Security Team  
Reviewers: Backend Team  
Date created: 2025-01-15  
Last updated: 2025-01-15

## Open Questions
- Гранулярность permissions для различных операций
- Стратегия миграции существующих проверок доступа