<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HhIntegrationController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">hh</a> &gt; <a href="index.source.html" class="el_package">nick.hh.controllers</a> &gt; <span class="el_source">HhIntegrationController.java</span></div><h1>HhIntegrationController.java</h1><pre class="source lang-java linenums">package nick.hh.controllers;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import java.util.ArrayList;
import java.util.List;
import lombok.extern.slf4j.Slf4j;
import nick.hh.dtos.CoverLetterRequest;
import nick.hh.dtos.ResumeFullResponse;
import nick.hh.dtos.auto.AutoApplyResponse;
import nick.hh.dtos.vacansies.VacancyItem;
import nick.hh.dtos.vacansies.VacancyResponse;
import nick.hh.dtos.vacansies.VacancySearchRequest;
import nick.hh.services.CoverLetterService;
import nick.hh.services.HhApiService;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

/**
 * Контроллер для откликов.
 */
<span class="nc" id="L30">@Slf4j</span>
@RestController
@RequestMapping(&quot;/api/hh&quot;)
@Tag(name = &quot;HH Integration API&quot;, description = &quot;Интеграция с HeadHunter и генерация писем&quot;)
public class HhIntegrationController {

    private final HhApiService hhApiService;
    private final CoverLetterService coverLetterService;

    /**
     * Конструктор.
     */
<span class="nc" id="L42">    public HhIntegrationController(HhApiService hhApiService, CoverLetterService coverLetterService) {</span>
<span class="nc" id="L43">        this.hhApiService = hhApiService;</span>
<span class="nc" id="L44">        this.coverLetterService = coverLetterService;</span>
<span class="nc" id="L45">    }</span>

    /**
     * Получение резюме.
     */
    @Operation(summary = &quot;Получить резюме по ID&quot;)
    @GetMapping(&quot;/resumes/{id}&quot;)
    public ResumeFullResponse getResume(@PathVariable String id) {
<span class="nc" id="L53">        return hhApiService.getResumeById(id);</span>
    }

    /**
     * Получение резюме.
     */
    @Operation(summary = &quot;Получить описание вакансии&quot;)
    @GetMapping(&quot;/vacancies/{id}&quot;)
    public VacancyResponse getVacancy(@PathVariable String id) {
<span class="nc" id="L62">        return hhApiService.getVacancy(id);</span>
    }

    /**
     * Получение резюме.
     */
    @Operation(summary = &quot;Сгенерировать сопроводительное письмо&quot;)
    @PostMapping(&quot;/cover-letter&quot;)
    public String generateCoverLetter(@RequestBody CoverLetterRequest request) {
<span class="nc" id="L71">        var resume = hhApiService.getResumeById(request.getResumeId());</span>
<span class="nc" id="L72">        var vacancy = hhApiService.getVacancy(request.getVacancyId());</span>
<span class="nc" id="L73">        return coverLetterService.generateCoverLetter(resume, vacancy, &quot;&quot;);</span>
    }

    /**
     * Получение резюме.
     */
    @Operation(summary = &quot;Отправить отклик на вакансию&quot;)
    @PostMapping(&quot;/apply/{vacancyId}&quot;)
    public void applyForVacancy(
        @PathVariable String vacancyId,
        @RequestParam String resumeId,
        @RequestParam String coverLetter) {
<span class="nc" id="L85">        hhApiService.sendApplication(vacancyId, resumeId, coverLetter);</span>
<span class="nc" id="L86">    }</span>

    /**
     * Получение резюме.
     */
    @PostMapping(&quot;/auto-apply&quot;)
    public ResponseEntity&lt;List&lt;AutoApplyResponse&gt;&gt; autoApplyForVacancies(
        @Valid @RequestBody VacancySearchRequest searchRequest,
        @RequestParam String resumeId
    ) {

        try {
<span class="nc" id="L98">            ResumeFullResponse resume = hhApiService.getResumeById(resumeId);</span>
<span class="nc" id="L99">            int maxApps = searchRequest.getMaxApplications();</span>

<span class="nc" id="L101">            List&lt;AutoApplyResponse&gt; results = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L102">            int page = 0;</span>
<span class="nc" id="L103">            int appliedCount = 0;</span>

<span class="nc bnc" id="L105" title="All 2 branches missed.">            while (appliedCount &lt; maxApps) {</span>
<span class="nc" id="L106">                List&lt;VacancyItem&gt; vacancies = hhApiService.searchVacancies(</span>
                    searchRequest, page
                );

<span class="nc bnc" id="L110" title="All 2 branches missed.">                if (vacancies.isEmpty()) {</span>
<span class="nc" id="L111">                    break;</span>
                }

<span class="nc bnc" id="L114" title="All 2 branches missed.">                for (VacancyItem vacancy : vacancies) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                    if (appliedCount &gt;= maxApps) {</span>
<span class="nc" id="L116">                        break;</span>
                    }

                    try {
<span class="nc" id="L120">                        VacancyResponse vacancyDetails = hhApiService.getVacancy(vacancy.getId());</span>
<span class="nc" id="L121">                        String coverLetter = coverLetterService</span>
<span class="nc" id="L122">                            .generateCoverLetter(resume, vacancyDetails, searchRequest.getCoverLetterContext());</span>

<span class="nc" id="L124">                        hhApiService.sendApplication(vacancy.getId(), resumeId, coverLetter);</span>
<span class="nc" id="L125">                        appliedCount++;</span>

<span class="nc" id="L127">                        log.info(&quot;Applied count: {}&quot;, appliedCount);</span>

<span class="nc" id="L129">                        results.add(new AutoApplyResponse(</span>
<span class="nc" id="L130">                            vacancy.getId(),</span>
<span class="nc" id="L131">                            vacancy.getName(),</span>
<span class="nc" id="L132">                            vacancy.getEmployer().getName(),</span>
                            coverLetter,
                            &quot;SUCCESS&quot;
                        ));

                        // Пауза между запросами
<span class="nc" id="L138">                        Thread.sleep(1000);</span>

<span class="nc" id="L140">                    } catch (Exception e) {</span>
<span class="nc" id="L141">                        results.add(new AutoApplyResponse(</span>
<span class="nc" id="L142">                            vacancy.getId(),</span>
<span class="nc" id="L143">                            vacancy.getName(),</span>
<span class="nc" id="L144">                            vacancy.getEmployer().getName(),</span>
                            null,
<span class="nc" id="L146">                            &quot;ERROR: &quot; + e.getMessage()</span>
                        ));
<span class="nc" id="L148">                    }</span>
<span class="nc" id="L149">                }</span>
<span class="nc" id="L150">                page++;</span>
<span class="nc" id="L151">            }</span>

<span class="nc" id="L153">            log.info(&quot;Auto-apply completed. Applied to {} vacancies.&quot;, appliedCount);</span>
<span class="nc" id="L154">            return ResponseEntity.ok(results);</span>

<span class="nc" id="L156">        } catch (Exception e) {</span>
<span class="nc" id="L157">            log.error(&quot;Auto-apply failed&quot;, e);</span>
<span class="nc" id="L158">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L159">                .body(List.of(new AutoApplyResponse(</span>
<span class="nc" id="L160">                    null, &quot;Error&quot;, e.getMessage(), null, &quot;GLOBAL_ERROR&quot;</span>
                )));
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>